<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS Terrain Tools - 地形生成工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="terrainGenerator.js"></script>
    <style>
        :root {
            --primary-color: #66ccff;
            --secondary-color: #4CAF50;
            --accent-color: #FF5722;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-radius: 10px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .app-title {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: none;
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .btn {
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .form-control, .form-range {
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            padding: 0.75rem;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }
        
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .terrain-params {
            background: #f0f9f0;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: none;
        }
        
        .terrain-mode {
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        
        .terrain-mode-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .terrain-mode-title {
            font-weight: 500;
            margin-left: 0.5rem;
            color: var(--text-color);
        }
        
        #heightChart {
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--shadow);
            border: none;
        }
        
        .chart-container {
            position: relative;
            margin-top: 2rem;
        }
        
        .chart-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .control-group {
            flex: 1;
        }
        
        .mode-switch {
            margin-bottom: 1rem;
        }
        
        .legend {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            border-left: none;
        }
        
        .card-header.generate {
            background: var(--secondary-color);
        }
        
        .tab-button.green-tab {
            background: var(--secondary-color);
            color: white;
        }
        
        .tab-button.active.green-tab {
            background: var(--secondary-color);
            color: white;
        }
        
        .form-check-input:checked {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .form-label .text-primary {
            color: var(--secondary-color) !important;
        }
        
        .text-success {
            color: var(--secondary-color) !important;
        }
        
        #generateRandomHeight {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            font-weight: bold;
        }
        
        #generateRandomHeight:hover {
            background: #45a049;
            border-color: #45a049;
        }
        
        .terrain-mode-icon {
            color: var(--secondary-color);
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        
        /* 设置高级选项区域的绿色主题 */
        .advanced-options .collapse-header {
            color: var(--secondary-color);
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
            padding-bottom: 0.5rem;
        }
        
        .advanced-options h6 {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .advanced-options .card-body {
            background-color: #f8fff8;
            border-radius: var(--border-radius);
            border-left: none;
        }
        
        .advanced-title {
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed rgba(76, 175, 80, 0.3);
            margin-bottom: 1rem;
        }
        
        .btn-outline-success {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-success:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* 保持图表和预览区使用蓝色 */
        #heightChart {
            border: none;
        }
        
        .chart-container .legend {
            border-left: none;
        }
        
        /* 预览页面中的缩放值使用蓝色 */
        #previewHeightParams #zoomValue {
            color: var(--primary-color) !important;
        }
        
        /* 预览页面的所有高亮文本使用蓝色 */
        #previewHeightParams .text-primary {
            color: var(--primary-color) !important;
        }

        /* 全局强制覆盖 */
        .text-primary {
            color: var(--primary-color) !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">SFS Terrain Tools</h1>
            <p class="app-subtitle">SFS地形生成与编辑工具</p>
            
            <div class="tab-navigation">
                <button class="tab-button active green-tab" id="randomTab">
                    <i class="fas fa-mountain"></i> 生成地形
                </button>
                <button class="tab-button" id="previewTab">
                    <i class="fas fa-eye"></i> 预览文件
                </button>
                <button class="tab-button" id="helpTab">
                    <i class="fas fa-question-circle"></i> 使用帮助
                </button>
        </div>
        </header>

        <div id="randomHeightParams" class="card">
            <div class="card-header generate">
                <span>地形生成参数配置</span>
            </div>
            <div class="card-body">
                <div class="terrain-params">
                    <div class="row g-3">
                        <div class="col-md-4">
            <div class="mb-3">
                                <label for="maxHeight" class="form-label">
                                    最大高度
                                </label>
                                <div class="input-group">
                <input type="number" class="form-control" id="maxHeight" value="100">
                                    <span class="input-group-text">米</span>
                                </div>
            </div>
                        </div>
                        <div class="col-md-4">
            <div class="mb-3">
                                <label for="minHeight" class="form-label">
                                    最小高度
                                </label>
                                <div class="input-group">
                <input type="number" class="form-control" id="minHeight" value="-100">
                                    <span class="input-group-text">米</span>
                                </div>
            </div>
            </div>
                        <div class="col-md-4">
            <div class="mb-3">
                                <label for="genPlanetRadius" class="form-label">
                                    星球半径
                                </label>
                                <div class="input-group">
                                <input type="number" class="form-control" id="genPlanetRadius" value="1000">
                                    <span class="input-group-text">米</span>
                                </div>
            </div>
            </div>
                        <div class="col-md-4">
            <div class="mb-3">
                                <label for="nodeCount" class="form-label">
                                    节点数量
                                </label>
                                <input type="number" class="form-control" id="nodeCount" value="10000" min="100" max="10000" step="100">
            </div>
                        </div>
                        <div class="col-md-4">
            <div class="mb-3">
                                <label for="decimalPlaces" class="form-label">
                                    保留小数位
                                </label>
                                <input type="number" class="form-control" id="decimalPlaces" value="2" min="0" max="6">
            </div>
            </div>
                    </div>
                </div>
        
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-mountain"></i>
                                </div>
                                <label class="terrain-mode-title" for="mountainMode">山脉</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="mountainMode" checked>
                                </div>
            </div>
            <div class="mb-3">
                                <label for="mountainProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="mountainProbValue" class="text-success">3个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="mountainProb" min="0" max="5" value="3">
            </div>
            </div>
            </div>

                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <label class="terrain-mode-title" for="volcanoMode">火山</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="volcanoMode">
                                </div>
            </div>
            <div class="mb-3">
                                <label for="volcanoProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="volcanoProbValue" class="text-success">2个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="volcanoProb" min="0" max="3" value="2">
            </div>
            </div>
        </div>

                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-angle-double-right"></i>
                                </div>
                                <label class="terrain-mode-title" for="plainsMode">平原</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="plainsMode" checked>
                                </div>
    </div>
        <div class="mb-3">
                                <label for="plainsProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="plainsProbValue" class="text-success">3个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="plainsProb" min="0" max="4" value="3">
        </div>
        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-circle-notch"></i>
                                </div>
                                <label class="terrain-mode-title" for="craterMode">撞击坑</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="craterMode">
                                </div>
        </div>
        <div class="mb-3">
                                <label for="craterProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="craterProbValue" class="text-success">3个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="craterProb" min="0" max="3" value="3">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-water"></i>
                                </div>
                                <label class="terrain-mode-title" for="oceanMode">海洋</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="oceanMode">
                                </div>
        </div>
        <div class="mb-3">
                                <label for="oceanProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="oceanProbValue" class="text-success">2个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="oceanProb" min="0" max="4" value="2">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="terrain-mode">
                            <div class="terrain-mode-header">
                                <div class="terrain-mode-icon">
                                    <i class="fas fa-square"></i>
                                </div>
                                <label class="terrain-mode-title" for="plateauMode">高原</label>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" id="plateauMode" checked>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="plateauProb" class="form-label d-flex justify-content-between">
                                    <span>生成密度:</span>
                                    <span id="plateauProbValue" class="text-success">2个/10000单位</span>
                                </label>
                                <input type="range" class="form-range" id="plateauProb" min="0" max="4" value="2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 advanced-options">
                    <button class="collapse-header" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions" aria-expanded="false" aria-controls="advancedOptions">
                        <span><i class="fas fa-sliders-h me-2 text-success"></i> 高级选项</span>
                        <i class="arrow-icon"></i>
                    </button>
                    <div class="collapse" id="advancedOptions">
                        <div class="card-body">
                            <div class="row">
                                <!-- 配置文件操作 -->
                                <div class="col-12 mb-4">
                                    <h6 class="advanced-title"><i class="fas fa-cog me-2"></i>配置文件操作</h6>
                                    <div class="btn-group config-actions">
                                        <button class="btn btn-outline-success" id="exportConfig">
                                            <i class="fas fa-download"></i> 导出配置
                                        </button>
                                        <button class="btn btn-outline-success" id="importConfig">
                                            <i class="fas fa-upload"></i> 导入配置
                                        </button>
                                        <input type="file" id="configFile" accept=".txt,.json" style="display: none;">
                                    </div>
                                </div>

                                <!-- 山脉参数 -->
                                <div class="col-12 mb-4" id="mountainAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-mountain me-2"></i>山脉参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="mountainWidth" class="form-label d-flex justify-content-between">
                                                <span>山脉宽度:</span>
                                                <span id="mountainWidthValue" class="text-success">1000节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="mountainWidth" min="0.01" max="0.3" value="0.1" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="mountainHeight" class="form-label d-flex justify-content-between">
                                                <span>山脉高度:</span>
                                                <span id="mountainHeightValue" class="text-success">0.7</span>
                                            </label>
                                            <input type="range" class="form-range" id="mountainHeight" min="0.1" max="1.0" value="0.7" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="mountainRoughness" class="form-label d-flex justify-content-between">
                                                <span>山脉粗糙度:</span>
                                                <span id="mountainRoughnessValue" class="text-success">0.5</span>
                                            </label>
                                            <input type="range" class="form-range" id="mountainRoughness" min="0" max="1" value="0.5" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 火山参数 -->
                                <div class="col-12 mb-4" id="volcanoAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-fire me-2"></i>火山参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="volcanoWidth" class="form-label d-flex justify-content-between">
                                                <span>火山宽度:</span>
                                                <span id="volcanoWidthValue" class="text-success">1000节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoWidth" min="0.01" max="0.3" value="0.1" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="volcanoHeight" class="form-label d-flex justify-content-between">
                                                <span>火山高度:</span>
                                                <span id="volcanoHeightValue" class="text-success">0.7</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoHeight" min="0.1" max="1.0" value="0.7" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="volcanoSteepness" class="form-label d-flex justify-content-between">
                                                <span>火山陡峭度:</span>
                                                <span id="volcanoSteepnessValue" class="text-success">0.7</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoSteepness" min="0" max="1" value="0.7" step="0.1">
                                        </div>
                                        <div class="col-md-4 mt-3">
                                            <label for="volcanoCraterWidth" class="form-label d-flex justify-content-between">
                                                <span>火山口宽度:</span>
                                                <span id="volcanoCraterWidthValue" class="text-success">50节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoCraterWidth" min="20" max="150" value="50" step="10">
                                        </div>
                                        <div class="col-md-4 mt-3">
                                            <label for="volcanoCraterDepth" class="form-label d-flex justify-content-between">
                                                <span>火山口深度:</span>
                                                <span id="volcanoCraterDepthValue" class="text-success">0.45</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoCraterDepth" min="0.2" max="0.7" value="0.45" step="0.05">
                                        </div>
                                    </div>
                                </div>

                                <!-- 平原参数 -->
                                <div class="col-12 mb-4" id="plainsAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-angle-double-right me-2"></i>平原参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="plainsWidth" class="form-label d-flex justify-content-between">
                                                <span>平原宽度:</span>
                                                <span id="plainsWidthValue" class="text-success">1000节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="plainsWidth" min="0.01" max="0.3" value="0.1" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="plainsHeight" class="form-label d-flex justify-content-between">
                                                <span>平原高度:</span>
                                                <span id="plainsHeightValue" class="text-success">0.1</span>
                                            </label>
                                            <input type="range" class="form-range" id="plainsHeight" min="0" max="0.3" value="0.1" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="plainsRoughness" class="form-label d-flex justify-content-between">
                                                <span>平原粗糙度:</span>
                                                <span id="plainsRoughnessValue" class="text-success">0.3</span>
                                            </label>
                                            <input type="range" class="form-range" id="plainsRoughness" min="0" max="1" value="0.3" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 撞击坑参数 -->
                                <div class="col-12 mb-4" id="craterAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-circle-notch me-2"></i>撞击坑参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="craterWidth" class="form-label d-flex justify-content-between">
                                                <span>撞击坑宽度:</span>
                                                <span id="craterWidthValue" class="text-primary">1000节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="craterWidth" min="0.01" max="0.3" value="0.1" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="craterDepth" class="form-label d-flex justify-content-between">
                                                <span>撞击坑深度:</span>
                                                <span id="craterDepthValue" class="text-primary">0.5</span>
                                            </label>
                                            <input type="range" class="form-range" id="craterDepth" min="0.1" max="1.0" value="0.5" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="craterRimHeight" class="form-label d-flex justify-content-between">
                                                <span>边缘高度:</span>
                                                <span id="craterRimHeightValue" class="text-primary">0.4</span>
                                            </label>
                                            <input type="range" class="form-range" id="craterRimHeight" min="0.1" max="1.0" value="0.4" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 海洋参数 -->
                                <div class="col-12 mb-4" id="oceanAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-water me-2"></i>海洋参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="oceanWidth" class="form-label d-flex justify-content-between">
                                                <span>海洋宽度:</span>
                                                <span id="oceanWidthValue" class="text-primary">1500节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="oceanWidth" min="0.01" max="0.3" value="0.15" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="oceanDepth" class="form-label d-flex justify-content-between">
                                                <span>海洋深度:</span>
                                                <span id="oceanDepthValue" class="text-primary">0.3</span>
                                            </label>
                                            <input type="range" class="form-range" id="oceanDepth" min="0.1" max="1.0" value="0.3" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="oceanLevel" class="form-label d-flex justify-content-between">
                                                <span>海平面高度:</span>
                                                <span id="oceanLevelValue" class="text-primary">-0.2</span>
                                            </label>
                                            <input type="range" class="form-range" id="oceanLevel" min="-0.5" max="0" value="-0.2" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 高原参数 -->
                                <div class="col-12 mb-4" id="plateauAdvanced" style="display: none;">
                                    <h6 class="advanced-title"><i class="fas fa-square me-2"></i>高原参数</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="plateauWidth" class="form-label d-flex justify-content-between">
                                                <span>高原宽度:</span>
                                                <span id="plateauWidthValue" class="text-primary">1500节点</span>
                                            </label>
                                            <input type="range" class="form-range" id="plateauWidth" min="0.01" max="0.3" value="0.15" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="plateauHeight" class="form-label d-flex justify-content-between">
                                                <span>高原高度:</span>
                                                <span id="plateauHeightValue" class="text-primary">0.8</span>
                                            </label>
                                            <input type="range" class="form-range" id="plateauHeight" min="0.1" max="1.0" value="0.8" step="0.1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="plateauRoughness" class="form-label d-flex justify-content-between">
                                                <span>高原粗糙度:</span>
                                                <span id="plateauRoughnessValue" class="text-primary">0.3</span>
                                            </label>
                                            <input type="range" class="form-range" id="plateauRoughness" min="0" max="1" value="0.3" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 优先级参数 -->
                                <div class="col-12 mb-4">
                                    <h6><i class="fas fa-layer-group me-2"></i>地貌优先级 <span class="badge bg-warning text-dark">谨慎修改</span></h6>
                                    <p class="small text-muted">调整地貌的相互影响优先级，数值越高优先级越高。修改可能会显著影响地形生成结果。</p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="mountainPriority" class="form-label d-flex justify-content-between">
                                                <span>山脉优先级:</span>
                                                <span id="mountainPriorityValue" class="text-success">5</span>
                                            </label>
                                            <input type="range" class="form-range" id="mountainPriority" min="1" max="10" value="5" step="1">
                            </div>
                                        <div class="col-md-6">
                                            <label for="volcanoPriority" class="form-label d-flex justify-content-between">
                                                <span>火山优先级:</span>
                                                <span id="volcanoPriorityValue" class="text-success">8</span>
                                            </label>
                                            <input type="range" class="form-range" id="volcanoPriority" min="1" max="10" value="8" step="1">
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label for="craterPriority" class="form-label d-flex justify-content-between">
                                                <span>撞击坑优先级:</span>
                                                <span id="craterPriorityValue" class="text-success">6</span>
                                            </label>
                                            <input type="range" class="form-range" id="craterPriority" min="1" max="10" value="6" step="1">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="plateauPriority" class="form-label d-flex justify-content-between">
                                                <span>高原优先级:</span>
                                                <span id="plateauPriorityValue" class="text-success">4</span>
                                            </label>
                                            <input type="range" class="form-range" id="plateauPriority" min="1" max="10" value="4" step="1">
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label for="plainsPriority" class="form-label d-flex justify-content-between">
                                                <span>平原优先级:</span>
                                                <span id="plainsPriorityValue" class="text-success">3</span>
                                            </label>
                                            <input type="range" class="form-range" id="plainsPriority" min="1" max="10" value="3" step="1">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="oceanPriority" class="form-label d-flex justify-content-between">
                                                <span>海洋优先级:</span>
                                                <span id="oceanPriorityValue" class="text-success">2</span>
                                            </label>
                                            <input type="range" class="form-range" id="oceanPriority" min="1" max="10" value="2" step="1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="terrain-params mt-4">
                    <div class="row">
                        <div class="col-md-12">
                            <button class="btn btn-success w-100 py-3" id="generateRandomHeight">
                                <i class="fas fa-cogs me-2"></i> 生成地形
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="previewHeightParams" class="card" style="display: none;">
            <div class="card-header">
                <span><i class="fas fa-eye me-2"></i> 高度文件预览</span>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="heightFile" class="form-label">选择高度文件</label>
                    <input type="file" class="form-control" id="heightFile" accept=".txt,.dat,.json">
                </div>

                <div class="chart-controls">
                    <div class="control-group">
                        <label for="planetRadius" class="form-label">星球半径</label>
                        <div class="input-group">
                        <input type="number" class="form-control" id="planetRadius" value="1000">
                            <span class="input-group-text">米</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="zoom" class="form-label d-flex justify-content-between">
                            <span>缩放:</span>
                            <span id="zoomValue" class="text-primary">1.0</span>
                        </label>
                        <input type="range" class="form-range" id="zoom" min="0.1" max="5" value="1" step="0.1">
                    </div>
                </div>

                <div class="mode-switch mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="circularMode">
                        <label class="form-check-label" for="circularMode">
                            <i class="fas fa-globe me-2"></i> 星球模式
                        </label>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="heightChart" width="800" height="400"></canvas>
                    <div class="legend">
                        <div>最高: <span id="maxHeightPreview">0</span>m</div>
                        <div>最低: <span id="minHeightPreview">0</span>m</div>
                        <div>平均: <span id="avgHeightPreview">0</span>m</div>
                        <div>高度比例: <span id="heightRatioPreview">0</span>%</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="helpSection" class="card mt-4" style="display: none;">
            <div class="card-header">
                <span><i class="fas fa-info-circle me-2"></i> 关于 SFS Terrain Tools</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-tools me-2"></i> 工具说明</h5>
                <p>SFS Terrain Tools 是一个用于生成和编辑SFS(Spaceflight Simulator)地形文件的工具。</p>
                <p class="mt-3">开发者：SFSGamer</p>
                <p class="mt-2">
                    <a href="https://space.bilibili.com/3494369438993272" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-user me-1"></i> 作者主页
                    </a>
                </p>

                        <h5 class="mt-4"><i class="fas fa-book me-2"></i> 使用说明</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><i class="fas fa-check me-2 text-success"></i> 点击"生成地形"选项卡进入生成模式</li>
                            <li class="list-group-item"><i class="fas fa-check me-2 text-success"></i> 点击"预览文件"选项卡进入预览模式</li>
                            <li class="list-group-item"><i class="fas fa-check me-2 text-success"></i> 生成的地形文件可以直接用于游戏中</li>
                </ul>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-mountain me-2"></i> 地形特征</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-mountain text-primary me-2"></i> <strong>山脉</strong></td>
                                        <td>连绵起伏的山地地形</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-fire text-danger me-2"></i> <strong>火山</strong></td>
                                        <td>带有火山口的锥形地形</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-angle-double-right text-success me-2"></i> <strong>平原</strong></td>
                                        <td>较为平坦的地形</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-circle-notch text-warning me-2"></i> <strong>撞击坑</strong></td>
                                        <td>陨石坑地形</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-water text-info me-2"></i> <strong>海洋</strong></td>
                                        <td>低洼地形</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-square text-secondary me-2"></i> <strong>高原</strong></td>
                                        <td>高度较高的平坦地形</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h5 class="mt-4"><i class="fas fa-exclamation-triangle me-2 text-warning"></i> 注意事项</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><i class="fas fa-arrow-right me-2"></i> 生成完成后请及时保存地形文件</li>
                            <li class="list-group-item"><i class="fas fa-arrow-right me-2"></i> 地形生成后可以在游戏中进一步修改</li>
                </ul>
                    </div>
            </div>
        </div>
        </div>

        <footer class="mt-5 mb-3 text-center text-muted">
            <p>SFS Terrain Tools | 版本 1.0</p>
            <p><small>适用于 Spaceflight Simulator 游戏</small></p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 辅助函数：显示详细错误信息
        function logErrorDetails(error, message) {
            console.error(message, error);
            console.error('错误名称:', error.name);
            console.error('错误信息:', error.message);
            console.error('错误堆栈:', error.stack);
            
            // 在开发环境中添加错误信息到页面（可选）
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = `<strong>错误:</strong> ${message}<br>
                                      <strong>详细信息:</strong> ${error.message}<br>
                                      <pre style="font-size: 0.8rem;">${error.stack}</pre>`;
                document.body.appendChild(errorDiv);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 标签页切换功能
            const randomTab = document.getElementById('randomTab');
            const previewTab = document.getElementById('previewTab');
            const helpTab = document.getElementById('helpTab');
            
            const randomHeightParams = document.getElementById('randomHeightParams');
            const previewHeightParams = document.getElementById('previewHeightParams');
            const helpSection = document.getElementById('helpSection');
            
            randomTab.addEventListener('click', function() {
                // 更新标签样式
                randomTab.classList.add('active');
                randomTab.classList.add('green-tab');
                previewTab.classList.remove('active');
                helpTab.classList.remove('active');
                
                // 更新内容区域显示
                randomHeightParams.style.display = 'block';
                previewHeightParams.style.display = 'none';
                helpSection.style.display = 'none';
                
                console.log("切换到生成地形页面");
            });
            
            previewTab.addEventListener('click', function() {
                // 更新标签样式
                randomTab.classList.remove('active');
                randomTab.classList.remove('green-tab');
                previewTab.classList.add('active');
                helpTab.classList.remove('active');
                
                // 更新内容区域显示
                randomHeightParams.style.display = 'none';
                previewHeightParams.style.display = 'block';
                helpSection.style.display = 'none';
                
                console.log("切换到预览文件页面");
            });
            
            helpTab.addEventListener('click', function() {
                // 更新标签样式
                randomTab.classList.remove('active');
                randomTab.classList.remove('green-tab');
                previewTab.classList.remove('active');
                helpTab.classList.add('active');
                
                // 更新内容区域显示
                randomHeightParams.style.display = 'none';
                previewHeightParams.style.display = 'none';
                helpSection.style.display = 'block';
                
                console.log("切换到使用帮助页面");
            });

            // 初始化地形模式的显示/隐藏
            const terrainModes = ['mountain', 'volcano', 'plains', 'crater', 'ocean', 'plateau'];
            terrainModes.forEach(mode => {
                const checkbox = document.getElementById(mode + 'Mode');
                        const advancedSection = document.getElementById(mode + 'Advanced');
                
                if (checkbox && advancedSection) {
                    // 设置初始状态
                    advancedSection.style.display = checkbox.checked ? 'block' : 'none';
                    
                    // 添加变化监听
                    checkbox.addEventListener('change', function() {
                            advancedSection.style.display = this.checked ? 'block' : 'none';
                    });
                }
            });

            // 确保所有range input的值显示正确
            document.querySelectorAll('input[type="range"]').forEach(input => {
                const valueDisplay = document.getElementById(input.id + 'Value');
                if (valueDisplay) {
                    // 设置初始值
                    if (input.id.includes('Prob')) {
                        valueDisplay.textContent = input.value + '个/10000单位';
                    } else if (input.id.includes('Width') && !input.id.includes('Crater')) {
                        const nodeCount = parseInt(document.getElementById('nodeCount').value);
                        const nodes = Math.round(nodeCount * parseFloat(input.value));
                        valueDisplay.textContent = nodes + '节点';
                    } else if (input.id === 'volcanoCraterWidth') {
                        valueDisplay.textContent = input.value + '节点';
                    } else {
                        valueDisplay.textContent = input.value;
                    }
                    
                    // 添加变化监听
                    input.addEventListener('input', function() {
                        if (input.id.includes('Prob')) {
                            valueDisplay.textContent = this.value + '个/10000单位';
                        } else if (input.id.includes('Width') && !input.id.includes('Crater')) {
                            const nodeCount = parseInt(document.getElementById('nodeCount').value);
                            const nodes = Math.round(nodeCount * parseFloat(this.value));
                            valueDisplay.textContent = nodes + '节点';
                        } else if (input.id === 'volcanoCraterWidth') {
                            valueDisplay.textContent = this.value + '节点';
                        } else {
                            valueDisplay.textContent = this.value;
                        }
                    });
                }
            });

            // 添加节点数量变化监听，更新所有宽度显示
            document.getElementById('nodeCount').addEventListener('change', function() {
                const nodeCount = parseInt(this.value);
                document.querySelectorAll('input[type="range"]').forEach(input => {
                    if (input.id.includes('Width') && !input.id.includes('Crater')) {
                        const valueDisplay = document.getElementById(input.id + 'Value');
                        if (valueDisplay) {
                            const nodes = Math.round(nodeCount * parseFloat(input.value));
                            valueDisplay.textContent = nodes + '节点';
                        }
                    }
                });
            });

            // 添加数值范围验证
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    const value = parseFloat(this.value);
                    
                    if (!isNaN(min) && value < min) {
                        this.value = min;
                    }
                    if (!isNaN(max) && value > max) {
                        this.value = max;
                    }
                });
            });

            // 确保配置文件导入后正确更新UI
            function updateUIFromConfig(config) {
                for (const [key, value] of Object.entries(config)) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === 'true' || value === true;
                            // 触发change事件以显示/隐藏高级选项
                            element.dispatchEvent(new Event('change'));
                        } else if (element.type === 'range' || element.type === 'number') {
                            element.value = value;
                            element.dispatchEvent(new Event('input'));
                        }
                    }
                }
                
                // 更新显示的值
                document.querySelectorAll('input[type="range"]').forEach(input => {
                    const valueDisplay = document.getElementById(input.id + 'Value');
                    if (valueDisplay) {
                        if (input.id.includes('Priority')) {
                            valueDisplay.textContent = input.value;
                        } else if (input.id.includes('Prob')) {
                            valueDisplay.textContent = input.value + '个/10000单位';
                        } else if (input.id.includes('Width') && !input.id.includes('Crater')) {
                            const nodeCount = parseInt(document.getElementById('nodeCount').value);
                            const nodes = Math.round(nodeCount * parseFloat(input.value));
                            valueDisplay.textContent = nodes + '节点';
                        } else if (input.id === 'volcanoCraterWidth') {
                            valueDisplay.textContent = input.value + '节点';
                        } else {
                            valueDisplay.textContent = input.value;
                        }
                    }
                });
            }

            // 加载配置
            const configText = localStorage.getItem('terrainConfig');
            if (configText) {
                try {
                    const config = JSON.parse(configText);
                    updateUIFromConfig(config);
                } catch (error) {
                    console.error('加载配置时出错:', error);
                }
            }

            // 导出配置文件功能
            document.getElementById('exportConfig').addEventListener('click', function() {
                // 收集所有配置参数
                const config = {
                    // 基础参数
                    maxHeight: document.getElementById('maxHeight').value,
                    minHeight: document.getElementById('minHeight').value,
                    planetRadius: document.getElementById('genPlanetRadius').value,
                    nodeCount: document.getElementById('nodeCount').value,
                    decimalPlaces: document.getElementById('decimalPlaces').value,
                    
                    // 优先级参数
                    mountainPriority: document.getElementById('mountainPriority').value,
                    volcanoPriority: document.getElementById('volcanoPriority').value,
                    craterPriority: document.getElementById('craterPriority').value,
                    plateauPriority: document.getElementById('plateauPriority').value,
                    plainsPriority: document.getElementById('plainsPriority').value,
                    oceanPriority: document.getElementById('oceanPriority').value,
                    
                    // 山脉参数
                    mountainEnabled: document.getElementById('mountainMode').checked,
                    mountainProb: document.getElementById('mountainProb').value,
                    mountainWidth: document.getElementById('mountainWidth').value,
                    mountainHeight: document.getElementById('mountainHeight').value,
                    mountainRoughness: document.getElementById('mountainRoughness').value,
                    
                    // 火山参数
                    volcanoEnabled: document.getElementById('volcanoMode').checked,
                    volcanoProb: document.getElementById('volcanoProb').value,
                    volcanoWidth: document.getElementById('volcanoWidth').value,
                    volcanoHeight: document.getElementById('volcanoHeight').value,
                    volcanoSteepness: document.getElementById('volcanoSteepness').value,
                    volcanoCraterWidth: document.getElementById('volcanoCraterWidth').value,
                    volcanoCraterDepth: document.getElementById('volcanoCraterDepth').value,
                    
                    // 平原参数
                    plainsEnabled: document.getElementById('plainsMode').checked,
                    plainsProb: document.getElementById('plainsProb').value,
                    plainsWidth: document.getElementById('plainsWidth').value,
                    plainsHeight: document.getElementById('plainsHeight').value,
                    plainsRoughness: document.getElementById('plainsRoughness').value,
                    
                    // 撞击坑参数
                    craterEnabled: document.getElementById('craterMode').checked,
                    craterProb: document.getElementById('craterProb').value,
                    craterWidth: document.getElementById('craterWidth').value,
                    craterDepth: document.getElementById('craterDepth').value,
                    craterRimHeight: document.getElementById('craterRimHeight').value,
                    
                    // 海洋参数
                    oceanEnabled: document.getElementById('oceanMode').checked,
                    oceanProb: document.getElementById('oceanProb').value,
                    oceanWidth: document.getElementById('oceanWidth').value,
                    oceanDepth: document.getElementById('oceanDepth').value,
                    oceanLevel: document.getElementById('oceanLevel').value,
                    
                    // 高原参数
                    plateauEnabled: document.getElementById('plateauMode').checked,
                    plateauProb: document.getElementById('plateauProb').value,
                    plateauWidth: document.getElementById('plateauWidth').value,
                    plateauHeight: document.getElementById('plateauHeight').value,
                    plateauRoughness: document.getElementById('plateauRoughness').value,
                    
                    // 编辑参数
                    zoom: document.getElementById('zoom').value,
                    circularMode: document.getElementById('circularMode').checked
                };
                
                // 保存到本地存储
                localStorage.setItem('terrainConfig', JSON.stringify(config));
                
                // 下载配置文件
                const blob = new Blob([JSON.stringify(config, null, 4)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'terrain_config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                alert('配置已导出！');
            });
            
            // 导入配置
            document.getElementById('importConfig').addEventListener('click', function() {
                document.getElementById('configFile').click();
            });
            
            document.getElementById('configFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log("开始读取配置文件:", file.name);
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        console.log("配置文件读取成功，内容长度:", e.target.result.length);
                        const config = JSON.parse(e.target.result);
                        
                        // 确保传递了必要的参数
                        if (!config.maxHeight) config.maxHeight = 100;
                        if (!config.minHeight) config.minHeight = -100;
                        if (!config.nodeCount) config.nodeCount = 10000;
                        
                        // 确保planetRadius/genPlanetRadius变量同步
                        if (config.planetRadius && !config.genPlanetRadius) {
                            config.genPlanetRadius = config.planetRadius;
                        } else if (config.genPlanetRadius && !config.planetRadius) {
                            config.planetRadius = config.genPlanetRadius;
                        }
                        
                        updateUIFromConfig(config);
                        localStorage.setItem('terrainConfig', JSON.stringify(config));
                        alert('配置已导入！');
                    } catch (error) {
                        console.error('配置导入失败:', error);
                        alert('配置文件格式不正确！错误信息: ' + error.message);
                    }
                };
                reader.onerror = function(e) {
                    console.error('读取配置文件时出错:', e);
                    alert('读取配置文件时出错！');
                };
                reader.readAsText(file);
            });

            // 添加高度文件预览功能
            document.getElementById('heightFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log("开始读取高度文件:", file.name);

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        console.log("文件读取成功，内容长度:", e.target.result.length);
                        
                        const content = e.target.result;
                        let heightData;
                        
                        try {
                            heightData = JSON.parse(content);
                            console.log("JSON解析成功:", heightData);
                        } catch (jsonError) {
                            console.error("JSON解析失败:", jsonError);
                            // 尝试解析旧格式
                            const lines = content.split('\n');
                            const points = [];
                            for (const line of lines) {
                                const trimmedLine = line.trim();
                                if (trimmedLine && !isNaN(parseFloat(trimmedLine))) {
                                    points.push(parseFloat(trimmedLine));
                                }
                            }
                            
                            if (points.length > 0) {
                                console.log("旧格式解析成功，点数:", points.length);
                                heightData = { points: points };
                            } else {
                                throw new Error('无法解析文件内容为高度数据');
                            }
                        }
                        
                        if (!heightData.points || !Array.isArray(heightData.points) || heightData.points.length === 0) {
                            throw new Error('无效的高度文件格式或数据为空');
                        }

                        const heights = heightData.points;
                        console.log("高度数据点数:", heights.length);
                        console.log("高度数据范围:", Math.min(...heights), "到", Math.max(...heights));
                        
                        // 尝试获取planetRadius，如果失败则使用默认值或genPlanetRadius
                        let planetRadius;
                        try {
                            planetRadius = parseFloat(document.getElementById('planetRadius').value);
                            if (isNaN(planetRadius)) {
                                planetRadius = parseFloat(document.getElementById('genPlanetRadius').value) || 1000;
                            }
                        } catch (error) {
                            console.warn("获取planetRadius失败，使用默认值:", error);
                            planetRadius = 1000;
                        }
                        
                        console.log("使用行星半径:", planetRadius);
                        
                        // 计算统计数据
                        const maxHeight = Math.max(...heights);
                        const minHeight = Math.min(...heights);
                        const avgHeight = heights.reduce((a, b) => a + b, 0) / heights.length;
                        const heightRatio = ((maxHeight - minHeight) / planetRadius * 100).toFixed(2);

                        // 更新统计信息显示
                        try {
                            document.getElementById('maxHeightPreview').textContent = maxHeight.toFixed(2);
                            document.getElementById('minHeightPreview').textContent = minHeight.toFixed(2);
                            document.getElementById('avgHeightPreview').textContent = avgHeight.toFixed(2);
                            document.getElementById('heightRatioPreview').textContent = heightRatio;
                        } catch (error) {
                            console.warn("更新统计信息失败:", error);
                        }

                        // 获取画布上下文
                        const canvas = document.getElementById('heightChart');
                        const ctx = canvas.getContext('2d');
                        
                        // 尝试获取zoom设置
                        let zoom;
                        try {
                            zoom = parseFloat(document.getElementById('zoom').value);
                            if (isNaN(zoom)) zoom = 1.0;
                        } catch (error) {
                            console.warn("获取缩放比例失败，使用默认值:", error);
                            zoom = 1.0;
                        }
                        
                        // 尝试获取显示模式
                        let isCircular;
                        try {
                            isCircular = document.getElementById('circularMode').checked;
                        } catch (error) {
                            console.warn("获取显示模式失败，使用默认值:", error);
                            isCircular = false;
                        }
                        
                        console.log("开始绘制图表，模式:", isCircular ? "星球" : "线性");

                        // 清空画布
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        if (isCircular) {
                            // 星球模式 - 圆形展示
                            drawCircularChart(ctx, canvas, heights, planetRadius, zoom);
                        } else {
                            // 线性模式 - 直线展示
                            drawLinearChart(ctx, canvas, heights, maxHeight, minHeight, zoom);
                        }
                        
                        console.log("图表绘制完成");
                    } catch (error) {
                        console.error('预览高度文件时出错:', error);
                        alert('无法解析高度文件，请确保文件格式正确！\n错误信息: ' + error.message);
                    }
                };
                
                reader.onerror = function(e) {
                    console.error('读取文件时出错:', e);
                    alert('读取高度文件时出错！请检查文件格式或文件是否损坏。');
                };
                
                reader.readAsText(file);
            });
            
            // 圆形图表绘制函数
            function drawCircularChart(ctx, canvas, heights, planetRadius, zoom) {
                            const centerX = canvas.width / 2;
                            const centerY = canvas.height / 2;
                            const baseRadius = Math.min(canvas.width, canvas.height) * 0.35; // 基准圆半径
                            const heightScale = baseRadius / planetRadius; // 根据行星半径计算高度缩放比例
                            
                            // 绘制基准圆
                            ctx.beginPath();
                            ctx.strokeStyle = '#666666';
                            ctx.lineWidth = 1;
                            ctx.setLineDash([5, 5]);
                            ctx.arc(centerX, centerY, baseRadius, 0, Math.PI * 2);
                            ctx.stroke();
                            ctx.setLineDash([]);

                            // 绘制地形线
                            ctx.beginPath();
                            ctx.strokeStyle = '#66ccff';
                            ctx.lineWidth = 2;

                            // 计算每个点的位置
                            heights.forEach((height, index) => {
                                const angle = (index / heights.length) * Math.PI * 2;
                                // 使用实际高度相对于行星半径的比例来计算显示半径
                                const radius = baseRadius + (height * heightScale * zoom);
                                const x = centerX + radius * Math.cos(angle);
                                const y = centerY + radius * Math.sin(angle);
                                
                                if (index === 0) {
                                    ctx.moveTo(x, y);
                                } else {
                                    ctx.lineTo(x, y);
                                }
                            });

                            // 闭合路径
                            const firstAngle = 0;
                            const firstRadius = baseRadius + (heights[0] * heightScale * zoom);
                ctx.lineTo(centerX + firstRadius * Math.cos(firstAngle), centerY + firstRadius * Math.sin(firstAngle));

                            ctx.stroke();

                // 添加角度刻度
                            ctx.fillStyle = '#666666';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('0°', centerX, centerY - baseRadius - 20);
                            ctx.fillText('90°', centerX + baseRadius + 20, centerY);
                            ctx.fillText('180°', centerX, centerY + baseRadius + 20);
                            ctx.fillText('270°', centerX - baseRadius - 20, centerY);
            }

            // 线性图表绘制函数
            function drawLinearChart(ctx, canvas, heights, maxHeight, minHeight, zoom) {
                            const xScale = canvas.width / heights.length;
                            const totalHeight = Math.max(Math.abs(maxHeight), Math.abs(minHeight)) * 2;
                            const yScale = (canvas.height * 0.8) / totalHeight * zoom;
                            const yCenter = canvas.height / 2;

                            // 绘制中心线（0高度线）
                            ctx.beginPath();
                            ctx.strokeStyle = '#666666';
                            ctx.lineWidth = 1;
                            ctx.setLineDash([5, 5]);
                            ctx.moveTo(0, yCenter);
                            ctx.lineTo(canvas.width, yCenter);
                            ctx.stroke();
                            ctx.setLineDash([]);

                            // 绘制地形线
                            ctx.beginPath();
                            ctx.strokeStyle = '#66ccff';
                            ctx.lineWidth = 2;
                            heights.forEach((height, index) => {
                                const x = index * xScale;
                                const y = yCenter - height * yScale;
                                
                                if (index === 0) {
                                    ctx.moveTo(x, y);
                                } else {
                                    ctx.lineTo(x, y);
                                }
                            });
                            ctx.stroke();

                            // 添加高度刻度
                            ctx.fillStyle = '#666666';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'right';
                            
                            ctx.fillText(maxHeight.toFixed(2) + 'm', canvas.width - 10, yCenter - maxHeight * yScale);
                            ctx.fillText(minHeight.toFixed(2) + 'm', canvas.width - 10, yCenter - minHeight * yScale);
                            ctx.fillText('0m', canvas.width - 10, yCenter);
                        }

            // 添加缩放和模式切换的实时更新
            document.getElementById('zoom').addEventListener('input', function() {
                document.getElementById('zoomValue').textContent = this.value;
                const heightFile = document.getElementById('heightFile');
                if (heightFile.files.length > 0) {
                    // 触发文件重新加载以重绘图表
                    const event = new Event('change');
                    heightFile.dispatchEvent(event);
                }
            });

            document.getElementById('circularMode').addEventListener('change', function() {
                const heightFile = document.getElementById('heightFile');
                if (heightFile.files.length > 0) {
                    // 触发文件重新加载以重绘图表
                    const event = new Event('change');
                    heightFile.dispatchEvent(event);
                }
            });

            document.getElementById('planetRadius').addEventListener('input', function() {
                // 触发文件重新加载以更新预览
                const heightFile = document.getElementById('heightFile');
                if (heightFile.files[0]) {
                    heightFile.dispatchEvent(new Event('change'));
                }
            });

            // 初始化显示状态
            window.addEventListener('load', function() {
                // 默认显示生成页面
                randomTab.click();
            });
            
            // 添加生成地形按钮的点击事件处理
            document.getElementById('generateRandomHeight').addEventListener('click', function() {
                try {
                    // 收集所有参数
                    const params = {
                        maxHeight: parseFloat(document.getElementById('maxHeight').value),
                        minHeight: parseFloat(document.getElementById('minHeight').value),
                        nodeCount: parseInt(document.getElementById('nodeCount').value),
                        planetRadius: parseFloat(document.getElementById('genPlanetRadius').value),
                        decimalPlaces: parseInt(document.getElementById('decimalPlaces').value)
                    };
                    
                    // 验证最大高度和最小高度的有效性
                    if (params.maxHeight <= params.minHeight) {
                        alert('错误：最大高度必须大于最小高度！');
                        return;
                    }
                    
                    // 验证节点数量的有效性
                    if (isNaN(params.nodeCount) || params.nodeCount < 100 || params.nodeCount > 1000000) {
                        params.nodeCount = 10000; // 使用默认值
                        console.warn("节点数量无效，使用默认值:", params.nodeCount);
                    }
                    
                    // 确保小数位数是有效的整数
                    if (isNaN(params.decimalPlaces) || params.decimalPlaces < 0 || params.decimalPlaces > 6) {
                        params.decimalPlaces = 2; // 使用默认值
                        console.warn("小数位数无效，使用默认值:", params.decimalPlaces);
                    }
                    
                    console.log("创建地形生成器，参数：", params);
                    
                    // 创建地形生成器实例
                    const generator = new TerrainGenerator(params);
                    
                    // 收集所有地形特征选项，添加错误处理和默认值
                    const getIntValue = (elementId, defaultValue = 1) => {
                        try {
                            const val = parseInt(document.getElementById(elementId).value);
                            return isNaN(val) ? defaultValue : val;
                        } catch (e) {
                            console.warn(`获取${elementId}值失败，使用默认值:`, e);
                            return defaultValue;
                        }
                    };
                    
                    const getFloatValue = (elementId, defaultValue = 0.5) => {
                        try {
                            const val = parseFloat(document.getElementById(elementId).value);
                            return isNaN(val) ? defaultValue : val;
                        } catch (e) {
                            console.warn(`获取${elementId}值失败，使用默认值:`, e);
                            return defaultValue;
                        }
                    };
                    
                    const getChecked = (elementId, defaultValue = false) => {
                        try {
                            return document.getElementById(elementId).checked;
                        } catch (e) {
                            console.warn(`获取${elementId}勾选状态失败，使用默认值:`, e);
                            return defaultValue;
                        }
                    };
                    
                    // 计算地形特征数量，确保符合用户设置
                    const calculateFeatureCount = (probId, defaultProb = 3) => {
                        // 获取用户设置的数量
                        const prob = getIntValue(probId, defaultProb);
                        
                        // 直接使用用户设置的数值，不再进行随机化
                        // 如果用户勾选了该特征，则使用设定的数值，否则返回0
                        const count = prob;
                        
                        console.log(`为${probId}计算的特征数量: ${count} (直接使用用户设置)`);
                        return count;
                    };
                    
                    const options = {
                        mountain: {
                            enabled: getChecked('mountainMode', false),
                            count: calculateFeatureCount('mountainProb', 3),
                            width: getFloatValue('mountainWidth', 0.1),
                            height: getFloatValue('mountainHeight', 0.5),
                            roughness: getFloatValue('mountainRoughness', 0.3),
                            priority: getIntValue('mountainPriority', 5)
                        },
                        volcano: {
                            enabled: getChecked('volcanoMode', false),
                            count: calculateFeatureCount('volcanoProb', 2),
                            width: getFloatValue('volcanoWidth', 0.1),
                            height: getFloatValue('volcanoHeight', 0.5),
                            steepness: getFloatValue('volcanoSteepness', 0.5),
                            craterWidth: getFloatValue('volcanoCraterWidth', 50),
                            craterDepth: getFloatValue('volcanoCraterDepth', 0.3),
                            priority: getIntValue('volcanoPriority', 8)
                        },
                        plains: {
                            enabled: getChecked('plainsMode', false),
                            count: calculateFeatureCount('plainsProb', 1),
                            width: getFloatValue('plainsWidth', 0.1),
                            height: getFloatValue('plainsHeight', 0.3),
                            roughness: getFloatValue('plainsRoughness', 0.3),
                            priority: getIntValue('plainsPriority', 3)
                        },
                        crater: {
                            enabled: getChecked('craterMode', false),
                            count: calculateFeatureCount('craterProb', 3),
                            width: getFloatValue('craterWidth', 0.1),
                            depth: getFloatValue('craterDepth', 0.5),
                            rimHeight: getFloatValue('craterRimHeight', 0.2),
                            priority: getIntValue('craterPriority', 6)
                        },
                        ocean: {
                            enabled: getChecked('oceanMode', false),
                            count: calculateFeatureCount('oceanProb', 2),
                            width: getFloatValue('oceanWidth', 0.15),
                            depth: getFloatValue('oceanDepth', 0.3),
                            level: getFloatValue('oceanLevel', 0),
                            priority: getIntValue('oceanPriority', 2)
                        },
                        plateau: {
                            enabled: getChecked('plateauMode', false),
                            count: calculateFeatureCount('plateauProb', 2),
                            width: getFloatValue('plateauWidth', 0.15),
                            height: getFloatValue('plateauHeight', 0.6),
                            roughness: getFloatValue('plateauRoughness', 0.3),
                            priority: getIntValue('plateauPriority', 4)
                        }
                    };
                    
                    console.log("生成地形，选项：", options);
                    
                    // 生成地形
                    const result = generator.generate(options);
                    
                    console.log("地形生成完成，生成了", generator.data.length, "个点");
                    
                    // 计算实际生成的最大值和最小值
                    let actualMin = Number.MAX_VALUE;
                    let actualMax = Number.MIN_VALUE;
                    
                    for (let i = 0; i < generator.data.length; i++) {
                        actualMin = Math.min(actualMin, generator.data[i]);
                        actualMax = Math.max(actualMax, generator.data[i]);
                    }
                    
                    console.log("实际高度范围：", actualMin.toFixed(2), "到", actualMax.toFixed(2));
                    
                    // 生成高度文件内容
                    const decimalPlaces = isNaN(params.decimalPlaces) ? 2 : params.decimalPlaces;
                    let heightFileContent = '{\n    "points": [\n';
                    generator.data.forEach((height, index) => {
                        heightFileContent += '        ' + height.toFixed(decimalPlaces);
                        if (index < generator.data.length - 1) {
                            heightFileContent += ',\n';
                        } else {
                            heightFileContent += '\n';
                        }
                    });
                    heightFileContent += '    ]\n}';
                    
                    // 创建并下载高度文件
                    const blob = new Blob([heightFileContent], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'heightmap.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // 更新调用方法中的LANDMARKS显示
                    let landmarksContent = '';
                    if (generator.landmarks && generator.landmarks.length > 0) {
                        generator.landmarks.forEach((landmark, index) => {
                            // 检查landmark对象的属性是否存在，如果不存在则使用默认值
                            const name = landmark.name || `地标${index + 1}`;
                            const angle = landmark.angle !== undefined ? landmark.angle.toFixed(1) : "0.0";
                            const startAngle = landmark.startAngle !== undefined ? landmark.startAngle.toFixed(1) : "0.0";
                            const endAngle = landmark.endAngle !== undefined ? landmark.endAngle.toFixed(1) : "0.0";
                            
                            landmarksContent += `{\n  "name": "${name}",\n  "angle": ${angle},\n  "startAngle": ${startAngle},\n  "endAngle": ${endAngle}\n}`;
                            if (index < generator.landmarks.length - 1) {
                                landmarksContent += ',\n';
                            }
                        });
                    } else {
                        landmarksContent = '// 未生成任何地标数据';
                    }
                    
                    // 计算星球周长，保留5位小数
                    const perimeter = (params.planetRadius * 2 * Math.PI).toFixed(5);
                    
                    // 创建调用方法模态框的HTML
                    let modalDiv = document.createElement('div');
                    modalDiv.className = 'modal fade';
                    modalDiv.id = 'methodModal';
                    modalDiv.setAttribute('tabindex', '-1');
                    modalDiv.setAttribute('aria-labelledby', 'methodModalLabel');
                    modalDiv.setAttribute('aria-hidden', 'true');
                    
                    modalDiv.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="methodModalLabel"><i class="fas fa-code me-2"></i>调用方法</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h6 class="mb-3">地形调用方法</h6>
                                    <div class="code-container bg-light p-3 rounded position-relative">
                                        <pre id="heightmapCode">OUTPUT = AddHeightMap(heightmap.txt,${perimeter}, 1)</pre>
                                        <button class="btn btn-sm btn-outline-primary copy-btn position-absolute top-0 end-0 m-2" 
                                                onclick="copyHeightmapCode()">
                                            <i class="fas fa-copy"></i> 复制
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6 class="mb-3">高度信息</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="alert alert-info">
                                                <small>设定高度范围：${params.minHeight} 到 ${params.maxHeight}</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="alert alert-success">
                                                <small>实际高度范围：${actualMin.toFixed(decimalPlaces)} 到 ${actualMax.toFixed(decimalPlaces)}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-3">LANDMARKS</h6>
                                    <div class="code-container bg-light p-3 rounded position-relative">
                                        <pre id="landmarksCode">${landmarksContent}</pre>
                                        <button class="btn btn-sm btn-outline-primary copy-btn position-absolute top-0 end-0 m-2" 
                                                onclick="copyLandmarksCode()">
                                            <i class="fas fa-copy"></i> 复制
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>`;
                    
                    // 删除之前的模态框(如果存在)
                    const oldModal = document.getElementById('methodModal');
                    if (oldModal) {
                        oldModal.remove();
                    }
                    
                    // 添加模态框到文档
                    document.body.appendChild(modalDiv);
                    
                    // 定义复制按钮的功能
                    window.copyHeightmapCode = function() {
                        const text = document.getElementById('heightmapCode').textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            const btn = document.querySelector('#heightmapCode + button');
                            const originalHTML = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                            
                            setTimeout(() => {
                                btn.innerHTML = originalHTML;
                                btn.classList.remove('btn-success');
                                btn.classList.add('btn-outline-primary');
                            }, 1500);
                        }).catch(err => {
                            console.error('复制失败:', err);
                            alert('复制失败，请手动复制文本');
                        });
                    };
                    
                    window.copyLandmarksCode = function() {
                        const text = document.getElementById('landmarksCode').textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            const btn = document.querySelector('#landmarksCode + button');
                            const originalHTML = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                            
                            setTimeout(() => {
                                btn.innerHTML = originalHTML;
                                btn.classList.remove('btn-success');
                                btn.classList.add('btn-outline-primary');
                            }, 1500);
                        }).catch(err => {
                            console.error('复制失败:', err);
                            alert('复制失败，请手动复制文本');
                        });
                    };
                    
                    // 显示模态框
                    try {
                        const methodModal = new bootstrap.Modal(document.getElementById('methodModal'));
                        methodModal.show();
                        console.log('模态框已显示');
                    } catch (error) {
                        console.error('显示模态框失败:', error);
                        alert('地形已生成并下载，但无法显示信息对话框。文件名: heightmap.txt');
                        
                        // 尝试使用jQuery方式显示模态框（兼容性处理）
                        try {
                            $('#methodModal').modal('show');
                            console.log('使用jQuery方式显示模态框');
                        } catch (jqError) {
                            console.error('使用jQuery显示模态框也失败:', jqError);
                            
                            // 最后尝试直接改变样式显示
                            try {
                                const modal = document.getElementById('methodModal');
                                modal.style.display = 'block';
                                modal.classList.add('show');
                                modal.setAttribute('aria-hidden', 'false');
                                document.body.classList.add('modal-open');
                                
                                // 创建背景遮罩
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                                
                                console.log('使用直接样式方式显示模态框');
                            } catch (styleError) {
                                console.error('使用样式方式显示模态框也失败:', styleError);
                            }
                        }
                    }
                } catch (error) {
                    console.error('生成地形时出错:', error);
                    alert('生成地形时出错: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>